// src/containers/ProfileUser/ProfileUser.jsx
import React, { useContext, useEffect, useMemo, useState } from "react";
import { Navigate, Link as RouterLink } from "react-router-dom";
import { UserContext } from "../../contexts/UserContext/UserContext";
import request from "../../utils/request";
import {
  Avatar,
  Badge,
  Box,
  Button,
  Card,
  CardActions,
  CardContent,
  CardMedia,
  Chip,
  CircularProgress,
  Divider,
  Grid,
  IconButton,
  LinearProgress,
  Modal,
  Stack,
  Tab,
  Tabs,
  TextField,
  Tooltip,
  Typography,
  useMediaQuery,
  useTheme,
  Alert,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
  ListItemButton,
} from "@mui/material";
import {
  Edit as EditIcon,
  Logout as LogoutIcon,
  Email as EmailIcon,
  Phone as PhoneIcon,
  CalendarMonth as CalendarIcon,
  WorkspacePremium as PremiumIcon,
  Shield as ShieldIcon,
  Favorite as FavoriteIcon,
  FavoriteBorder as FavoriteBorderIcon,
  Place as PlaceIcon,
  People as PeopleIcon,
  Chat as ChatIcon,
  Comment as CommentIcon,
  Groups as GroupsIcon,
  Terrain as TerrainIcon,
  PersonAdd as PersonAddIcon,
  Star as StarIcon,
} from "@mui/icons-material";

/* utils */
function fmtDate(d) {
  if (!d) return "‚Äî";
  const date = typeof d === "string" || typeof d === "number" ? new Date(d) : d;
  return Number.isNaN(date.getTime())
    ? "‚Äî"
    : date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
}

function getRoles(user) {
  if (!user) return [];
  if (Array.isArray(user.roles)) {
    if (typeof user.roles[0] === "string") return user.roles;
    return user.roles.map((r) => (typeof r === "string" ? r : r?.authority)).filter(Boolean);
  }
  return [];
}

// üî• Fonction pour g√©n√©rer la bonne URL d'image
const GOOGLE_API_KEY = "AIzaSyBHiBCqOdyA356J87JgT3ZWnKR2zr7_Rvs";
function getImageUrl(imagePath) {
  if (!imagePath) return "/images/no-image.png";
  if (imagePath.length > 100 && !imagePath.includes('/') && !imagePath.includes('.')) {
    return `https://maps.googleapis.com/maps/api/place/photo?photoreference=${imagePath}&maxwidth=400&key=${GOOGLE_API_KEY}`;
  }
  if (imagePath.startsWith("http://") || imagePath.startsWith("https://")) return imagePath;
  return `http://localhost:8088/api/v1/uploads/${imagePath}`;
}

/* assets */
const COVER_URL =
  "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop";
const DEFAULT_AVATAR =
  "https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-profiles/avatar-1.webp";

export default function ProfileUser() {
  const theme = useTheme();
  const isMdUp = useMediaQuery(theme.breakpoints.up("md"));
  const isXs = useMediaQuery(theme.breakpoints.down("sm"));

  const { token, setToken } = useContext(UserContext);
  const [user, setUser] = useState(null);
  const [redirect, setRedirect] = useState(false);
  const [tab, setTab] = useState(0);
  const [editOpen, setEditOpen] = useState(false);
  
  // üî• Nouveaux √©tats pour les donn√©es sociales
  const [socialData, setSocialData] = useState({
    favoriteSpots: [],
    favoriteHikingSpots: [],
    friends: [],
    groups: [],
    comments: [],
    unreadMessages: 0,
    loading: true,
  });

  // Chargement du profil utilisateur
  useEffect(() => {
    if (!token) {
      setRedirect(true);
      return;
    }

    (async () => {
      try {
        const res = await request(
          "http://localhost:8088/api/v1/auth/user",
          "GET",
          null,
          true
        );

        if (res.status === 200 && res.data?.userApp) {
          setUser(res.data.userApp);
        } else {
          setRedirect(true);
        }
      } catch (e) {
        console.error("Erreur profil :", e);
        setRedirect(true);
      }
    })();
  }, [token]);

  // üî• Chargement des donn√©es sociales
  useEffect(() => {
    if (!user?.id) return;

    const fetchSocialData = async () => {
      setSocialData(prev => ({ ...prev, loading: true }));
      
      try {
        // R√©cup√©ration parall√®le de toutes les donn√©es
        const [
          favSpots,
          favHikingSpots,
          friends,
          groups,
          comments,
          conversations,
        ] = await Promise.allSettled([
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/favorites/spots`, "GET", null, true),
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/favorites/hiking-spots`, "GET", null, true),
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/friends`, "GET", null, true),
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/groups`, "GET", null, true),
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/comments`, "GET", null, true),
          request(`http://localhost:8088/api/v1/user-relations/${user.id}/messages/unread/count`, "GET", null, true),
        ]);

        setSocialData({
          favoriteSpots: favSpots.status === 'fulfilled' ? (favSpots.value?.data?.spots || []) : [],
          favoriteHikingSpots: favHikingSpots.status === 'fulfilled' ? (favHikingSpots.value?.data?.hikingSpots || []) : [],
          friends: friends.status === 'fulfilled' ? (friends.value?.data?.friends || []) : [],
          groups: groups.status === 'fulfilled' ? (groups.value?.data?.groups || []) : [],
          comments: comments.status === 'fulfilled' ? (comments.value?.data?.comments || []) : [],
          unreadMessages: conversations.status === 'fulfilled' ? (conversations.value?.data || 0) : 0,
          loading: false,
        });
      } catch (error) {
        console.error("Erreur lors du chargement des donn√©es sociales:", error);
        setSocialData(prev => ({ ...prev, loading: false }));
      }
    };

    fetchSocialData();
  }, [user?.id]);

  const logOut = () => {
    localStorage.removeItem("token");
    setToken?.(null);
    setRedirect(true);
  };

  const roles = useMemo(() => getRoles(user), [user]);
  const isAdmin = roles.some((r) => String(r).toUpperCase().includes("ADMIN"));

  if (redirect) return <Navigate to="/login" replace />;
  if (!user)
    return (
      <Box sx={{ minHeight: "60vh", display: "flex", alignItems: "center", justifyContent: "center", gap: 2, px: 2 }}>
        <CircularProgress color="error" />
        <Typography variant="h6">Chargement du profil‚Ä¶</Typography>
      </Box>
    );

  const fullname = `${user.lastname || ""} ${user.firstname || ""}`.trim() || "Utilisateur";
  const email = user.email || "‚Äî";
  const phone = user.phone || user.phoneNumber || "‚Äî";
  const createdAt = user.createdAt || user.created_at;
  const avatarSize = isXs ? 90 : 120;

  // üî• Statistiques r√©elles
  const totalFavorites = socialData.favoriteSpots.length + socialData.favoriteHikingSpots.length;
  const totalFriends = socialData.friends.length;
  const totalGroups = socialData.groups.length;
  const totalComments = socialData.comments.length;

  return (
    <Box sx={{ bgcolor: (t) => (t.palette.mode === "dark" ? "#0b0d10" : "#f5f7fb"), py: 2 }}>
      <Box sx={{ maxWidth: 1200, mx: "auto", px: { xs: 1.5, sm: 2, md: 3 } }}>
        {/* Header/cover */}
        <Card sx={{ borderRadius: 3, overflow: "hidden", mb: 3, boxShadow: 3 }}>
          <Box
            sx={{
              height: { xs: 120, sm: 160, md: 200 },
              backgroundImage: `linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.45)), url(${COVER_URL})`,
              backgroundSize: "cover",
              backgroundPosition: "center",
            }}
          />
          <Box sx={{ position: "relative", p: { xs: 2, sm: 3 } }}>
            <Stack direction={{ xs: "column", sm: "row" }} alignItems={{ xs: "center", sm: "flex-end" }} spacing={2}>
              <Badge
                overlap="circular"
                anchorOrigin={{ vertical: "bottom", horizontal: "right" }}
                badgeContent={
                  <Tooltip title="V√©rifi√©">
                    <Avatar sx={{ width: 28, height: 28, bgcolor: "success.main", border: "2px solid white" }}>
                      <CheckIconSmall />
                    </Avatar>
                  </Tooltip>
                }
                sx={{ mt: { xs: -avatarSize / 2.2, sm: -avatarSize / 1.5 } }}
              >
                <Avatar
                  src={user.avatar || DEFAULT_AVATAR}
                  alt={fullname}
                  sx={{ width: avatarSize, height: avatarSize, border: "3px solid #fff" }}
                />
              </Badge>

              <Box sx={{ flex: 1, textAlign: { xs: "center", sm: "left" } }}>
                <Typography variant={isXs ? "h6" : "h5"} fontWeight={700}>
                  {fullname}
                </Typography>
                <Stack direction="row" spacing={1} justifyContent={{ xs: "center", sm: "flex-start" }} flexWrap="wrap">
                  {isAdmin && <Chip color="error" size="small" label="Administrateur" />}
                  {roles
                    .filter((r) => String(r).toUpperCase() !== "ROLE_ADMIN")
                    .slice(0, 3)
                    .map((r) => (
                      <Chip key={r} size="small" label={String(r).replace(/^ROLE_/, "")} />
                    ))}
                </Stack>
              </Box>

              <Stack direction={{ xs: "column", sm: "row" }} spacing={1} sx={{ width: { xs: "100%", sm: "auto" } }}>
                <Button fullWidth={isXs} variant="contained" color="error" startIcon={<EditIcon />} onClick={() => setEditOpen(true)}>
                  √âditer
                </Button>
                <Button fullWidth={isXs} variant="outlined" color="error" startIcon={<LogoutIcon />} onClick={logOut}>
                  Logout
                </Button>
              </Stack>
            </Stack>
          </Box>
        </Card>

        {/* Corps */}
        <Grid container spacing={{ xs: 2, md: 3 }}>
          <Grid item xs={12} md={4}>
            <Stack spacing={2}>
              {/* Carte infos contact */}
              <Card variant="outlined" sx={{ borderRadius: 2 }}>
                <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                  <Stack spacing={1.25}>
                    <Row icon={<EmailIcon fontSize="small" color="disabled" />} text={email} breakAll />
                    <Row icon={<PhoneIcon fontSize="small" color="disabled" />} text={phone} />
                    <Row
                      icon={<CalendarIcon fontSize="small" color="disabled" />}
                      text={`Membre depuis le ${fmtDate(createdAt)}`}
                    />
                    <Row icon={<PlaceIcon fontSize="small" color="disabled" />} text="Paris, France" />
                  </Stack>
                </CardContent>
              </Card>

              {/* üî• Statistiques r√©elles */}
              <Card variant="outlined" sx={{ borderRadius: 2 }}>
                <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                  {socialData.loading ? (
                    <Box sx={{ display: 'flex', justifyContent: 'center', py: 2 }}>
                      <CircularProgress size={24} />
                    </Box>
                  ) : (
                    <>
                      <Stack direction="row" justifyContent="space-between" textAlign="center">
                        <Stat label="Favoris" value={totalFavorites} icon={<FavoriteIcon color="error" fontSize="small" />} />
                        <Stat label="Amis" value={totalFriends} icon={<PeopleIcon color="primary" fontSize="small" />} />
                        <Stat label="Groupes" value={totalGroups} icon={<GroupsIcon color="success" fontSize="small" />} />
                      </Stack>
                      <Divider sx={{ my: 1.5 }} />
                      <Stack direction="row" justifyContent="space-between" textAlign="center">
                        <Stat label="Commentaires" value={totalComments} icon={<CommentIcon fontSize="small" />} />
                        <Stat 
                          label="Messages non lus" 
                          value={socialData.unreadMessages} 
                          icon={<ChatIcon color={socialData.unreadMessages > 0 ? "error" : "disabled"} fontSize="small" />} 
                        />
                      </Stack>
                      <Divider sx={{ my: 1.5 }} />
                      <Typography variant="caption" color="text.secondary">
                        Compl√©tion du profil
                      </Typography>
                      <LinearProgress 
                        sx={{ mt: 0.5, height: 8, borderRadius: 10 }} 
                        variant="determinate" 
                        value={Math.min(100, 60 + (totalFavorites > 0 ? 10 : 0) + (totalFriends > 0 ? 10 : 0) + (totalGroups > 0 ? 10 : 0) + (totalComments > 0 ? 10 : 0))} 
                      />
                    </>
                  )}
                </CardContent>
              </Card>
            </Stack>
          </Grid>

          <Grid item xs={12} md={8}>
            <Card sx={{ borderRadius: 3, boxShadow: 3 }}>
              <Tabs
                value={tab}
                onChange={(_, v) => setTab(v)}
                textColor="inherit"
                indicatorColor="primary"
                variant={isMdUp ? "standard" : "scrollable"}
                scrollButtons={isMdUp ? false : "auto"}
                allowScrollButtonsMobile
                sx={{ px: { xs: 0.5, sm: 1, md: 2 } }}
              >
                <Tab label="√Ä propos" />
                <Tab label={`Favoris (${totalFavorites})`} />
                <Tab label={`Amis (${totalFriends})`} />
                <Tab label={`Groupes (${totalGroups})`} />
                <Tab label="S√©curit√©" />
              </Tabs>
              <Divider />

              {/* Tab 0: √Ä propos */}
              {tab === 0 && (
                <Box sx={{ p: { xs: 1.5, sm: 2, md: 3 } }}>
                  <Typography variant="h6" fontWeight={700} gutterBottom>
                    Informations
                  </Typography>
                  <Grid container spacing={{ xs: 1.5, sm: 2 }}>
                    <InfoCard title="Nom complet" value={fullname} />
                    <InfoCard title="Email" value={email} breakAll />
                    <InfoCard title="T√©l√©phone" value={phone} />
                    <Grid item xs={12} sm={6}>
                      <Card variant="outlined" sx={{ borderRadius: 2, height: "100%" }}>
                        <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                          <Typography variant="overline" color="text.secondary">
                            R√¥les
                          </Typography>
                          <Stack direction="row" spacing={1} flexWrap="wrap">
                            {roles.length ? (
                              roles.map((r) => <Chip key={r} size="small" label={String(r).replace(/^ROLE_/, "")} />)
                            ) : (
                              <Chip size="small" label="USER" />
                            )}
                          </Stack>
                        </CardContent>
                      </Card>
                    </Grid>
                    <Grid item xs={12}>
                      <Card variant="outlined" sx={{ borderRadius: 2 }}>
                        <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                          <Typography variant="overline" color="text.secondary">
                            Bio
                          </Typography>
                          <Typography variant="body1">
                            Passionn√© de nature et de cartographie. J'adore explorer de nouveaux sentiers et partager
                            des spots avec la communaut√©.
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                  </Grid>

                  <Typography variant="h6" fontWeight={700} sx={{ mt: 3 }} gutterBottom>
                    Badges
                  </Typography>
                  <Stack direction="row" spacing={1} flexWrap="wrap">
                    <Chip icon={<PremiumIcon />} color="warning" label="Explorateur" />
                    {totalComments > 5 && <Chip icon={<CommentIcon />} color="info" label="Commentateur actif" />}
                    {totalFriends > 10 && <Chip icon={<PeopleIcon />} color="primary" label="Sociable" />}
                    {totalFavorites > 20 && <Chip icon={<FavoriteIcon />} color="error" label="Collectionneur" />}
                    <Chip icon={<ShieldIcon />} color="success" label="Compte v√©rifi√©" />
                  </Stack>
                </Box>
              )}

              {/* üî• Tab 1: Favoris */}
              {tab === 1 && (
                <Box sx={{ p: { xs: 1.5, sm: 2, md: 3 } }}>
                  {socialData.loading ? (
                    <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                      <CircularProgress />
                    </Box>
                  ) : totalFavorites === 0 ? (
                    <Alert severity="info">Vous n'avez pas encore de spots favoris</Alert>
                  ) : (
                    <>
                      {socialData.favoriteSpots.length > 0 && (
                        <>
                          <Typography variant="h6" fontWeight={700} gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            <PlaceIcon color="error" />
                            Spots favoris ({socialData.favoriteSpots.length})
                          </Typography>
                          <Grid container spacing={2} sx={{ mb: 3 }}>
                            {socialData.favoriteSpots.map((spot) => (
                              <Grid item xs={12} sm={6} key={spot.id}>
                                <FavoriteSpotCard spot={spot} type="spot" />
                              </Grid>
                            ))}
                          </Grid>
                        </>
                      )}
                      
                      {socialData.favoriteHikingSpots.length > 0 && (
                        <>
                          <Typography variant="h6" fontWeight={700} gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                            <TerrainIcon color="success" />
                            Randonn√©es favorites ({socialData.favoriteHikingSpots.length})
                          </Typography>
                          <Grid container spacing={2}>
                            {socialData.favoriteHikingSpots.map((spot) => (
                              <Grid item xs={12} sm={6} key={spot.id}>
                                <FavoriteSpotCard spot={spot} type="hiking" />
                              </Grid>
                            ))}
                          </Grid>
                        </>
                      )}
                    </>
                  )}
                </Box>
              )}

              {/* üî• Tab 2: Amis */}
              {tab === 2 && (
                <Box sx={{ p: { xs: 1.5, sm: 2, md: 3 } }}>
                  {socialData.loading ? (
                    <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                      <CircularProgress />
                    </Box>
                  ) : totalFriends === 0 ? (
                    <Alert severity="info" action={
                      <Button size="small" startIcon={<PersonAddIcon />}>
                        Ajouter des amis
                      </Button>
                    }>
                      Vous n'avez pas encore d'amis
                    </Alert>
                  ) : (
                    <>
                      <Typography variant="h6" fontWeight={700} gutterBottom>
                        Mes amis ({totalFriends})
                      </Typography>
                      <List>
                        {socialData.friends.map((friend) => (
                          <ListItem 
                            key={friend.id}
                            secondaryAction={
                              <Button size="small" variant="outlined">
                                Voir profil
                              </Button>
                            }
                          >
                            <ListItemAvatar>
                              <Avatar src={friend.avatar || DEFAULT_AVATAR}>
                                {friend.firstname?.[0]}{friend.lastname?.[0]}
                              </Avatar>
                            </ListItemAvatar>
                            <ListItemText
                              primary={`${friend.firstname || ''} ${friend.lastname || ''}`}
                              secondary={friend.email}
                            />
                          </ListItem>
                        ))}
                      </List>
                    </>
                  )}
                </Box>
              )}

              {/* üî• Tab 3: Groupes */}
              {tab === 3 && (
                <Box sx={{ p: { xs: 1.5, sm: 2, md: 3 } }}>
                  {socialData.loading ? (
                    <Box sx={{ display: 'flex', justifyContent: 'center', py: 4 }}>
                      <CircularProgress />
                    </Box>
                  ) : totalGroups === 0 ? (
                    <Alert severity="info">Vous n'avez pas encore rejoint de groupes</Alert>
                  ) : (
                    <>
                      <Typography variant="h6" fontWeight={700} gutterBottom>
                        Mes groupes ({totalGroups})
                      </Typography>
                      <Grid container spacing={2}>
                        {socialData.groups.map((group) => (
                          <Grid item xs={12} sm={6} key={group.id}>
                            <Card variant="outlined" sx={{ borderRadius: 2 }}>
                              <CardContent>
                                <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 1 }}>
                                  <Avatar sx={{ bgcolor: 'primary.main' }}>
                                    <GroupsIcon />
                                  </Avatar>
                                  <Box sx={{ flex: 1 }}>
                                    <Typography variant="subtitle1" fontWeight={600}>
                                      {group.name}
                                    </Typography>
                                    <Typography variant="caption" color="text.secondary">
                                      {group.isPrivate ? 'üîí Priv√©' : 'üåç Public'}
                                    </Typography>
                                  </Box>
                                </Stack>
                                <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                                  {group.description || 'Pas de description'}
                                </Typography>
                                <Chip 
                                  size="small" 
                                  label={group.role || 'MEMBER'}
                                  color={group.role === 'OWNER' ? 'error' : group.role === 'ADMIN' ? 'warning' : 'default'}
                                />
                              </CardContent>
                            </Card>
                          </Grid>
                        ))}
                      </Grid>
                    </>
                  )}
                </Box>
              )}

              {/* Tab 4: S√©curit√© */}
              {tab === 4 && (
                <Box sx={{ p: { xs: 1.5, sm: 2, md: 3 } }}>
                  <Typography variant="h6" fontWeight={700} gutterBottom>
                    S√©curit√© du compte
                  </Typography>

                  <Card variant="outlined" sx={{ borderRadius: 2, mb: 2 }}>
                    <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                      <Stack direction="row" alignItems="center" spacing={1}>
                        <ShieldIcon color="success" />
                        <Typography variant="subtitle2">Authentification</Typography>
                      </Stack>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: 0.5 }}>
                        Mot de passe mis √† jour il y a 3 mois. 2FA non activ√©e.
                      </Typography>
                      <CardActions sx={{ px: 0 }}>
                        <Button size="small" variant="text">Modifier le mot de passe</Button>
                        <Button size="small" variant="text">Activer la 2FA</Button>
                      </CardActions>
                    </CardContent>
                  </Card>

                  <Card variant="outlined" sx={{ borderRadius: 2 }}>
                    <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
                      <Typography variant="subtitle2">Sessions actives</Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: 0.5 }}>
                        Chrome ‚Ä¢ Windows ‚Ä¢ Paris ‚Äî Derni√®re activit√©: {fmtDate(new Date())}
                      </Typography>
                      <CardActions sx={{ px: 0 }}>
                        <Button size="small" variant="text" color="error">
                          D√©connecter toutes les sessions
                        </Button>
                      </CardActions>
                    </CardContent>
                  </Card>
                </Box>
              )}
            </Card>
          </Grid>
        </Grid>
      </Box>

      {/* Modal d'√©dition */}
      <Modal open={editOpen} onClose={() => setEditOpen(false)}>
        <Box
          sx={{
            position: "absolute",
            top: { xs: 0, sm: "50%" },
            left: { xs: 0, sm: "50%" },
            transform: { xs: "none", sm: "translate(-50%, -50%)" },
            width: { xs: "100vw", sm: 560 },
            height: { xs: "100vh", sm: "auto" },
            maxWidth: "100vw",
            bgcolor: "background.paper",
            boxShadow: 24,
            borderRadius: { xs: 0, sm: 2 },
            p: { xs: 2, sm: 3 },
            overflowY: "auto",
          }}
        >
          <Stack direction="row" alignItems="center" justifyContent="space-between" sx={{ mb: 2 }}>
            <Typography variant="h6" fontWeight={700}>√âditer le profil</Typography>
            <IconButton onClick={() => setEditOpen(false)}>
              <CloseIcon />
            </IconButton>
          </Stack>
          <Grid container spacing={{ xs: 1.5, sm: 2 }}>
            <Grid item xs={12} sm={6}>
              <TextField fullWidth label="Nom" defaultValue={user.lastname || ""} />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField fullWidth label="Pr√©nom" defaultValue={user.firstname || ""} />
            </Grid>
            <Grid item xs={12}>
              <TextField fullWidth label="Bio" defaultValue="Passionn√© de nature‚Ä¶" multiline minRows={3} />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField fullWidth label="T√©l√©phone" defaultValue={phone || ""} />
            </Grid>
            <Grid item xs={12} sm={6}>
              <TextField fullWidth label="Ville" defaultValue="Paris" />
            </Grid>
          </Grid>
          <Stack direction="row" justifyContent={{ xs: "stretch", sm: "flex-end" }} spacing={1} sx={{ mt: 2 }}>
            <Button fullWidth={isXs} onClick={() => setEditOpen(false)}>Annuler</Button>
            <Button fullWidth={isXs} variant="contained" color="error" onClick={() => setEditOpen(false)}>
              Enregistrer (mock)
            </Button>
          </Stack>
        </Box>
      </Modal>
    </Box>
  );
}

/* üî• Composant pour afficher un spot favori */
function FavoriteSpotCard({ spot, type }) {
  const mainImage = type === 'spot' 
    ? getImageUrl(spot.imagePath || (spot.imageUrls && spot.imageUrls[0]))
    : getImageUrl(spot.imagePath || (spot.imageUrls && spot.imageUrls[0]));

  return (
    <Card variant="outlined" sx={{ borderRadius: 2, overflow: 'hidden' }}>
      <CardMedia
        component="img"
        height="120"
        image={mainImage}
        alt={spot.name}
        sx={{ objectFit: 'cover' }}
        onError={(e) => {
          e.currentTarget.onerror = null;
          e.currentTarget.src = "/images/no-image.png";
        }}
      />
      <CardContent sx={{ p: 1.5 }}>
        <Typography variant="subtitle2" fontWeight={600} gutterBottom>
          {spot.name}
        </Typography>
        <Typography variant="caption" color="text.secondary" sx={{ display: 'block', mb: 1 }}>
          {spot.description?.substring(0, 80)}...
        </Typography>
        <Stack direction="row" spacing={0.5} flexWrap="wrap">
          {spot.region && <Chip size="small" label={spot.region} />}
          {spot.difficultyLevel && <Chip size="small" label={`Diff. ${spot.difficultyLevel}`} color="warning" />}
          {spot.distance && <Chip size="small" label={`${spot.distance.toFixed(1)} km`} color="primary" />}
        </Stack>
      </CardContent>
      <CardActions>
        <Button 
          size="small" 
          component={RouterLink} 
          to={type === 'spot' ? `/spot/${spot.id}` : `/HikingSpot/${spot.id}`}
        >
          Voir d√©tails
        </Button>
        <IconButton size="small" color="error">
          <FavoriteIcon fontSize="small" />
        </IconButton>
      </CardActions>
    </Card>
  );
}

/* helpers UI */
function Row({ icon, text, breakAll }) {
  return (
    <Stack direction="row" spacing={1} alignItems="center">
      {icon}
      <Typography variant="body2" sx={breakAll ? { wordBreak: "break-all" } : undefined}>
        {text}
      </Typography>
    </Stack>
  );
}

function Stat({ label, value, icon }) {
  return (
    <Box sx={{ flex: 1 }}>
      <Stack direction="row" alignItems="center" justifyContent="center" spacing={0.5}>
        {icon}
        <Typography variant="h5" fontWeight={700}>{value}</Typography>
      </Stack>
      <Typography variant="caption" color="text.secondary">{label}</Typography>
    </Box>
  );
}

function InfoCard({ title, value, breakAll }) {
  return (
    <Grid item xs={12} sm={6}>
      <Card variant="outlined" sx={{ borderRadius: 2, height: "100%" }}>
        <CardContent sx={{ p: { xs: 1.5, sm: 2 } }}>
          <Typography variant="overline" color="text.secondary">{title}</Typography>
          <Typography variant="body1" sx={breakAll ? { wordBreak: "break-all" } : undefined}>{value}</Typography>
        </CardContent>
      </Card>
    </Grid>
  );
}

/* ic√¥nes l√©g√®res inline */
function CloseIcon(props) {
  return (
    <svg {...props} width="24" height="24" viewBox="0 0 24 24" fill="none">
      <path d="M18 6L6 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </svg>
  );
}

function CheckIconSmall() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17l-5-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
    </svg>
  );
}